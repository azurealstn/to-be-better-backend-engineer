# 쿠키와 세션

HTTP의 특징은 연결을 끊는 **Connectionless**와 상태를 유지하지 않는 **Stateless**이다.

> Connectionless: 요청 - 응답이 한번 수행되면 그 후로 해당 연결을 유지하지 않는다.  
> Stateless: 연결을 끊는 순간 클라이언트-서버의 통신이 끝나며 상태 정보는 유지하지 않는다.

HTTP는 Connectionless, Stateless 특징을 갖고 있기 때문에 매번 요청할 때마다 로그인을 수행해야 하는 문제점을 생긴다. 이러한 문제점을 보완하고자 나온 것이 쿠키와 세션이다.

## 쿠키(Cookie)

- 쿠키는 클라이언트(브라우저)에 `key:value` 형태로 저장된다.
- 쿠키는 유효 시간을 정할 수 있으며, 유효시간 내에 브라우저가 종료되어도 쿠키는 유지된다.
- 클라이언트에 300개까지 쿠키를 저장할 수 있지만 쿠키는 네트워크 부하를 발생시키므로, 최소한의 정보만 사용해야 한다. (세션 id, 인증 토큰)
- 서버에 전송하지 않고, 웹 브라우저 내부에 데이터를 저장하고 싶다면 웹 스토리지(localStorage, sessionStorage)를 사용하면 된다.

### 쿠키 - 생명주기

Expires, max-age

- Set-Cookie: expires=Sun, 17-Oct.... GMT
  - 만료일이 되면 쿠키 삭제
- Set-Cookie: max-age=3600 (3600)
  - 유효시간이 지나면 쿠키 삭제
- 세션 쿠키: Expires, max-age 옵션을 설정하지 않으면 브라우저가 종료될 때까지만 유지된다. (브라우저를 종료하면 쿠키 삭제)
- 영속 쿠키: Expires, max-age 옵션을 설정하면 브라우저가 종료되도 해당 날짜 또는 시간내에는 쿠키가 유지된다.

### 쿠키 - 도메인

Domain

지정한 Domain에만 쿠키가 생성된다.

- domain=example.org: Domain을 지정하면 기존 Domain과 서브 Domain까지 쿠키 접근이 가능하다.
  - Domain을 지정하지 않으면 기존 Domain에만 쿠키 접근이 가능하고, 서브 Domain은 접근이 불가능하다.

### 쿠키 - 경로

Path

- path=/: 해당 경로(/)를 포함한 하위 경로 페이지에만 쿠키 접근이 가능하다.

### 쿠키 - 보안

Secure, HttpOnly, SameSite

- Secure: Secure를 적용하면 https인 경우에만 전송이 가능하다.
  - 일반적으로 쿠키는 http, https를 구분하지 않고 전송이 된다.
- HttpOnly: XSS 공격을 방지한다.
  - 자바스크립트에서 접근 불가 (document.cookie)
  - HTTP 전송에만 사용한다.
- SameSite: XSRF(또는 CSRF) 공격을 방지한다.
  - 요청 도메인과 쿠키에 설정된 도메인이 같은 경우만 쿠키를 전송한다.

## 쿠키 동작 방식

1. 클라이언트 요청
2. 서버에서 쿠키 생성
3. HTTP 헤더에 쿠키를 포함시켜 응답
4. 클라이언트는 응답받은 쿠키를 브라우저에 저장
5. 이 후 같은 웹사이트를 방문시 클라이언트는 브라우저에 저장된 쿠키를 함께 전송한다.

## 세션

- **세션은 쿠키를 기반**하고 있지만, 브라우저에 저장하는 쿠키와는 달리 **세션은 서버에 저장하고 관리**한다.
- 서버는 각 클라이언트에게 세션 ID를 부여한다.
  - 클라이언트가 요청하면 서버는 클라이언트에게 유일한 ID를 부여하는데 이게 세션 ID이다.
- 브라우저에 저장하는 **쿠키보다는 보안에 좋지만**, 세션은 서버에 저장하기 때문에 **사용자가 많아질수록 서버 메모리를 많이 차지**하게 된다.
  - 이는 동접자 수가 많은 웹사이트인 경우 서버에 과부하를 주게되므로 성능 저하의 요인이 된다.

## 세션 동작 방식

1. 클라이언트 요청시 서버에서는 세션을 생성하고 관리
2. 서버는 클라이언트에게 세션 ID를 응답함
3. 이 때 서버에서는 응답 헤더에 Set-Cookie에 세션 ID를 담아서 응답함
4. 클라이언트는 요청시 쿠키에 저장되어 있는 세션 ID와 함께 전달함
5. 서버는 세션 ID를 조회하여 데이터를 가져옴
6. 가져온 데이터를 적절하게 처리하여 다시 클라이언트에게 응답함

## 쿠키와 세션의 차이

- 특징을 보면 쿠키와 세션은 비슷한 역할을 수행하며, 동작 방식도 비슷하다. 그 이유는 세션도 결국 쿠키를 사용하기 때문이다.
- 가장 큰 차이점은 저장되는 위치이다. 쿠키는 서버의 자원을 전혀 사용하지 않는 브라우저에 저장되고, 세션은 서버의 자원을 사용하는 서버에 저장된다.
- 보안면에서 쿠키보다 세션이 훨씬 안전하다. 다만 세션은 서버의 자원을 사용해야 하기 때문에 속도는 쿠키가 더 빠르다.
- 세션도 쿠키를 사용하지만 보안에 좋은 이유는 쿠키를 갈취당해도 쿠키값에는 sessionid로 저장되고, 이 sessionid는 해석할 수 없기 때문이다.
- 라이프 사이클에서 보면, 쿠키는 만료시간을 설정하면 브라우저가 종료되어도 정보가 유지된다. 하지만 세션은 만료시간을 설정해도 브라우저가 종료되면 삭제된다.
  - 크롬에서 다른 탭을 사용해도 세션을 공유되지만, 다른 브라우저(Edge)를 사용하게 되면 다른 세션을 사용할 수 있다.

## References

- [모든 개발자를 위한 HTTP 웹 기본 지식](https://www.inflearn.com/course/http-%EC%9B%B9-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC#)
- https://interconnection.tistory.com/74
- https://suzzeong.tistory.com/131
